---
title: "Project"
author: "Olga Potanina"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(openxlsx)
library (tidyverse)
```

## Чтение, слияние, редактирование исходных датасетов

-   Загрузка датасетов с информацией о здоровых людях (`info_healthy`) и пациентах с СРК (`info_ibs`)

```{r, message=FALSE}
info_healthy <- read_xlsx ("data/raw/final_health_statistic.xlsx")
info_ibs <- read_xlsx ("data/raw/final_ibs_141_statistic.xlsx")
```

-   Сравнение переменных в `info_healthy` и `info_ibs`

```{r, echo=FALSE}
c ("Уникальные переменные в info_ibs:", info_ibs %>% 
  select (- c (intersect (names(info_healthy), names(info_ibs)))) %>% colnames() )

c ("Уникальные переменные в info_healthy:", info_healthy %>% 
  select (- c (intersect (names(info_healthy), names(info_ibs)))) %>% colnames())
```

-   объединение `info_healthy` и `info_ibs` в единый датасет `combined_info` c редактированием содержимого

```{r combined_info, message=FALSE}
combined_info <- info_healthy %>% 
  bind_rows(info_ibs) %>%
  mutate (
    BMI_min = ifelse (is.na (BMI_min), round (Weight_min /(Height_max/100 * Height_max/100), 2), BMI_min),
    BMI_max = ifelse (is.na (BMI_max), round (Weight_max /(Height_min/100 * Height_min/100), 2), BMI_max)
    ) %>% 
  unite("BMI_range", BMI_min, BMI_max, sep = "-", na.rm = TRUE) %>%
  unite ("Age_range", Age_min, Age_max, sep = "-", na.rm = TRUE) %>%
  mutate(
    research_ID = as.factor(sub ("research_", "", research_ID)),
    patient_ID = as.factor (sub ("patient_", "", patient_ID)),
    Sex = ifelse (Sex == "mixed", NA, Sex),
    Smoking = sub ("never", "Never",  Smoking),
    Alcohol = sub ("rarely", "Rarely", Alcohol),
    Hygiene = case_when(
      Hygiene == "Occasionally (1-2 times/week) cosmetics" ~ "Occasionally cosmetics (1-2 times/week)",
      Hygiene == "Rarely (a few times/month) cosmetics" ~ "Rarely cosmetics (a few times/month)",
      TRUE ~ Hygiene),
    Physical_activity = sub ("regularly", "Regularly",  Smoking),
    BMI = ifelse (is.na(Weight_kg), BMI, Weight_kg/ (Height_cm/100 * Height_cm/100)),
    BMI_range = ifelse(BMI_range == "", NA, BMI_range),
    BMI_category = case_when(
      BMI_range == "18-25" ~ "normal/overweight",
      BMI_range == "19.21-29.29" ~ "normal/overweight",
      BMI_range == "20.6-29.6" ~ "normal/overweight",
      BMI_range == "21.74-28.38" ~ "normal/overweight",
      BMI_range == "18.5-30.8" ~ "normal/overweight", #немного больше 30
      BMI < 18.5 ~ "underweight",
      BMI >= 18.5 & BMI < 30 ~ "normal/overweight",
      BMI >= 30 ~ "obese")
    ) %>% 
  mutate_if (is.character, as.factor) %>% 
  select(-c(
    Instrument, # unique (combined_info$Instrument) = "Illumina MiSeq" 
    Isolation_source, # unique (combined_info$Isolation_source) = "faeces" 
    Assay_type, # unique (combined_info$Assay_type) = "AMPLICON"
    Target_gene, # unique (combined_info$Target_gene) = "16S"
    Main_Disease, # unique (combined_info$Main_Disease) = NA (for healthy), 141 (for ibs)
    Drugs, # unique (combined_info$Drugs) = NA
    Social_status, # unique (combined_info$Social_status) =  NA, urban 
    Weight_kg, Height_cm, Weight_min, Weight_max, Height_min, Height_max, BMI_range, #использованы для создания BMI_category, уменьшения количества NA в BMI
    Birth_Year, # имеются значения только в тех случаях, где возраст уже известен
    Age_range) # unique (combined_info$Age_range))) = 18-40, 23-28, 16-42, 21-43, 28-54
  )

```

-   Загрузка датасетов с данными о микробиоме здоровых людей (`bacteria_healthy`) и пациентов с СРК (`bacteria_ibs`) и их объединение в `combined_bacteria`

```{r combined_bacteria, message = FALSE}
bacteria_healthy <- read_csv("data/raw/final_bacteria_health.csv")
bacteria_ibs <- read_csv("data/raw/final_bacteria_ibs_141.csv")

combined_bacteria <- bacteria_healthy %>% 
  bind_rows (bacteria_ibs) %>% 
  mutate(
    patient_ID = as.factor (sub ("patient_", "", patient_ID))
    )

```

-   Объединение `combined_bacteria` и `combined_info` в `final_data_wide` c последующим сохранением в папке `originals`

```{r final_data_wide, message=FALSE}
final_data_wide <- combined_info %>% 
  bind_cols(combined_bacteria) %>% 
  rename(patient_ID = patient_ID...2) %>% 
  mutate(patient_ID...24 = NULL,
         patient_ID = row_number())

file_path <- "data/originals/final_data_wide.csv"
write_excel_csv(final_data_wide, file=file_path)
```

## Оценка доли NA и нулевых значений

-   Оценка доли NA в переменных `final_data_wide`

```{r}
final_data_wide %>% 
  select (where (function(x) sum (is.na(x))/ nrow(final_data_wide) * 100 > 0)) %>% 
  sapply (function(x) sum (is.na(x))/ nrow(final_data_wide) * 100) %>% round(1) %>% 
  as.data.frame() %>% 
  rename(NA_percentage = ".") %>% 
  mutate (
    "Number of people with known data" = round (nrow(final_data_wide) - NA_percentage/100 * nrow(final_data_wide),1),
    NA_percentage = paste (NA_percentage, "%", sep = " ")
    ) %>% 
  arrange(desc (NA_percentage))

```

-   Рассчитаем процент не NA и не 0 данных по колонкам длинного формата

```{r calculate percentage for each variable}
# Устанавливаем порог процента 
threshold_percent <- 101 # можно изменить процент в зависимости от нашего решения, пока выводим все переменные 
 
# Функция для вычисления процента записей, не равных NA и не равных 0, для каждой колонки 
calculate_percentage <- function(col) { 
  sum(!is.na(col) & col != 0) / length(col) * 100 
} 
 
# Применяем функцию к каждой колонке в датасете 
percentage_non_zero_non_na <- sapply(final_data_wide[, -1], calculate_percentage) 
 
# Создаем датафрейм с результатами 
result_df <- data.frame( 
  column = names(percentage_non_zero_non_na), 
  percentage = percentage_non_zero_non_na 
) 
 
# Отфильтровываем колонки, у которых процент записей менее threshold_percent% 
filtered_columns <- result_df[result_df$percentage < threshold_percent, ]

# Сохраним датасет в excel для дальнейшего анализа

file_path <- "data/originals/percentage_by_vars.xlsx"
write.xlsx(filtered_columns, file=file_path)
```

-   Рассчитаем процент не NA и не 0 данных по форматированному patient_ID

```{r}
# Устанавливаем порог процента 
threshold_percent <- 101 # можно изменить процент в зависимости от нашего решения, пока выводим все patient_ID 
 
# Рассчитываем процент значений, не являющихся NA и не равных 0, для каждого пациента 
percentage_non_zero_non_na <- rowMeans(!is.na(final_data_wide) & final_data_wide != 0, na.rm = TRUE) * 100 
 
# Создаем датафрейм с результатами 
result_df <- data.frame( 
  patient_id = final_data_wide$patient_ID, 
  percentage = percentage_non_zero_non_na 
) 
 
# Отфильтровываем пациентов, у которых процент значений менее threshold_percent% 
filtered_patients <- result_df[result_df$percentage < threshold_percent, ] 

# Сохраним датасет в excel для дальнейшего анализа 
file_path <- "data/originals/percentage_by_patient.xlsx"
write.xlsx(filtered_patients, file=file_path)
```
